name: Single SOCKS5 Proxy (Tailscale)

on:
  workflow_dispatch:

jobs:
  proxy:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Start Tailscale
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-proxy

      - name: Install Dante SOCKS5
        run: |
          sudo apt update -y
          sudo apt install -y dante-server

      - name: Configure Dante (SAFE)
        run: |
          sudo rm -f /etc/danted.conf
          echo "internal: 0.0.0.0 port = 1080" | sudo tee -a /etc/danted.conf
          echo "external: eth0" | sudo tee -a /etc/danted.conf
          echo "socksmethod: none" | sudo tee -a /etc/danted.conf
          echo "clientmethod: none" | sudo tee -a /etc/danted.conf
          echo "user.privileged: root" | sudo tee -a /etc/danted.conf
          echo "user.unprivileged: nobody" | sudo tee -a /etc/danted.conf
          echo "client pass { from: 0.0.0.0/0 to: 0.0.0.0/0 }" | sudo tee -a /etc/danted.conf
          echo "socks pass { from: 0.0.0.0/0 to: 0.0.0.0/0 }" | sudo tee -a /etc/danted.conf

      - name: Start Dante
        run: |
          sudo systemctl restart danted
          sudo systemctl status danted --no-pager

      - name: SHOW PROXY (THIS IS IT)
        run: |
          echo "=============================="
          echo "YOUR SOCKS5 PROXY:"
          tailscale ip -4 | sed 's/$/:1080/'
          echo "=============================="
          sleep 21600
