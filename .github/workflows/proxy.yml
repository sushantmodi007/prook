name: Single SOCKS5 Proxy (Tailscale)

on:
  workflow_dispatch:

jobs:
  proxy:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Start Tailscale
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-proxy

      - name: Install and Configure SOCKS5 (Dante)
        run: |
          sudo apt update -y
          sudo apt install -y dante-server

          sudo tee /etc/danted.conf > /dev/null <<EOF
internal: 0.0.0.0 port = 1080
external: eth0
socksmethod: none
clientmethod: none
user.privileged: root
user.unprivileged: nobody

client pass {
  from: 0.0.0.0/0 to: 0.0.0.0/0
}

socks pass {
  from: 0.0.0.0/0 to: 0.0.0.0/0
}
EOF

          sudo systemctl restart danted
          sudo systemctl status danted --no-pager

      - name: Show Proxy (USE THIS)
        run: |
          echo "=============================="
          echo "YOUR SOCKS5 PROXY:"
          tailscale ip -4 | sed 's/$/:1080/'
          echo "=============================="
          sleep 21600
